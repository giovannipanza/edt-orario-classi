<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Orario delle classi e variazioni</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
/* === TEMA INTERMEDIO (niente nero, contrasto morbido) === */
:root{
  --bg:#e9eeec;
  --card:#f7f9f8;
  --grid:#ccd7d3;
  --ink:#0f1412;
  --muted:#5a6a66;
  --accent:#3A7F73;
  --accent-strong:#2f685f;
  --shadow:0 18px 48px rgba(31, 68, 62, .10);
}

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

*{ box-sizing:border-box; }
body{
  margin:0;
  background:radial-gradient(circle at 20% 20%, #f4f7f6, #e5ebea), var(--bg);
  color:var(--ink);
  font-family:'Inter', system-ui, -apple-system, sans-serif;
  line-height:1.5;
}

.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:32px 20px 40px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

h1{
  margin:0;
  font-size:32px;
  letter-spacing:-0.02em;
}

.hint{ color:var(--muted); margin:4px 0 0; }

.card{
  background:var(--card);
  border:1px solid #d7e2df;
  border-radius:14px;
  box-shadow:var(--shadow);
  padding:18px;
}

.row{
  display:flex;
  align-items:flex-end;
  gap:12px;
  flex-wrap:wrap;
}

label{
  color:var(--muted);
  font-weight:600;
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:14px;
}

input[type=file],select,input[type=date],button{
  background:#ffffff;
  color:var(--ink);
  border:1px solid #cfdad7;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
  transition:all .15s ease;
  font-family:inherit;
}
select, input[type=date]{ min-width:170px; }
input[type=file]{ padding:9px 10px; }
input:focus, select:focus{ outline:2px solid color-mix(in srgb, var(--accent) 35%, #fff); border-color:var(--accent); }

button{
  cursor:pointer;
  background:linear-gradient(120deg, var(--accent), var(--accent-strong));
  color:#fff;
  font-weight:700;
  letter-spacing:0.02em;
  box-shadow:0 12px 24px rgba(58,127,115,.25);
}
button:disabled{
  opacity:0.6;
  cursor:default;
  background:#cfdad7;
  color:#4d5a58;
  box-shadow:none;
}
button:not(:disabled):hover{ transform:translateY(-1px); box-shadow:0 14px 32px rgba(58,127,115,.28); }
button:active{ transform:translateY(0); }

.status-row{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:8px;
  color:var(--muted);
}
.status-row.ok{ color:var(--accent-strong); font-weight:600; }
.status-row.err{ color:#b04353; font-weight:700; }
.status-row.warn{ color:#b67a12; font-weight:600; }
.loader{
  width:18px; height:18px;
  border-radius:50%;
  border:3px solid #cfdad7;
  border-top-color:var(--accent);
  animation:spin .9s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg); } }

thead th{ background:#dde7e4; color:#17322e; border-color:#cfdad7; }
.timecol{ background:#dde7e4; color:#365551; border-color:#cfdad7; }
table th,table td{ border-color:#cfdad7; }

thead th.today{ background:#d3e7e2; box-shadow: inset 0 -2px 0 var(--accent); }
.slot.today{ background:#e6f3f0; }

.course{
  background:#ffffff;
  border:1px solid #3A7F73;
  border-radius:12px;
  color:#0f1412;
  box-shadow:0 10px 22px rgba(58,127,115,.08);
  padding:8px 10px;
}
.course small{ color:#4e6662; }
.course .caps{ color:#2e6d62; font-weight:600; letter-spacing:0.02em; }

.course.cancelled{ background:#fdecef; border-color:#c0525d; box-shadow:0 10px 22px rgba(192,82,93,.12); }
/* ====== RESPONSIVE FIX ====== */

/* Il contenitore della tabella scorre in orizzontale nei display piccoli */
.tt{
  overflow:auto;                 /* già presente, lo ribadiamo */
  -webkit-overflow-scrolling:touch;
}

/* Riduci rigidità della tabella sui piccoli schermi */
table{ min-width: 720px; }       /* prima era 920px: più “mobile-friendly” */

/* Controlli in riga -> a colonne su mobile */
@media (max-width: 900px){
  .wrap{ padding: 0 12px; }
  h1{ font-size: 28px; line-height: 1.15; }
  .row{
    gap:10px;
    flex-wrap:wrap;
  }
  /* i controlli occupano tutta la larghezza e vanno a capo */
  label, select, input[type=date], input[type=file], button{
    width:100%;
    box-sizing:border-box;
  }
  /* spazi/padding più compatti */
  .card{ padding:14px; }
  th, td{ padding:6px 7px; }
  .course{ padding:6px 8px; border-radius:10px; }
  .course small{ display:block; font-size:12px; line-height:1.3; }
  .course strong{ font-size:14px; line-height:1.25; }
  /* colonna ora più stretta */
  .timecol{ width:70px; }
}

/* Telefono “stretto” */
@media (max-width: 600px){
  html, body{ font-size: 13px; }
  h1{ font-size: 24px; }
  .hint{ font-size: 12px; }
  /* disattiva sticky che su mobile può rompere lo scorrimento */
  thead th, .timecol{
    position: static;
  }
  /* rendi le celle un filo più alte per cliccare meglio */
  .slot{ min-height: 26px; }
  /* intestazioni con data più compatte (es: 20/10 invece di “20/10/2025” se lo usi) */
  thead th{ white-space: nowrap; }
}

/* Ultra-compatto (iPhone SE/vecchi Android) */
@media (max-width: 380px){
  html, body{ font-size: 12px; }
  .timecol{ width: 64px; }
  .course{ padding:5px 7px; }
  .course strong{ font-size:13px; }
  .course small{ font-size:11px; }
}

/* La tabella resta scrollabile e la colonna "Ora" è fissa */
.tt{
  overflow:auto;
  position:relative;
  border-radius:14px;
  background:#ffffff;
  box-shadow:var(--shadow);
  padding:10px;
}

.timecol{
  position: sticky;
  left: 0;
  z-index: 5;
  background: var(--card);
  box-shadow: 2px 0 5px rgba(0,0,0,.12); /* leggero bordo destro */
}

thead th.timecol{
  z-index: 6;
}

/* Bordi orizzontali uniformi */
table{
  border-collapse: collapse;
  border-spacing: 0;
  width: 100%;
  background:#fff;
  border-radius:10px;
}

table tr{
  border-bottom: 1px solid var(--grid);   /* bordo inferiore */
}

/* Tolgo completamente hover o sfumature */
tbody tr:hover{
  background: none;
}

table th, table td{
  border: none;             /* niente bordi verticali */
  padding: 6px 8px;
}

/* Mantengo le intestazioni con il loro bordo inferiore */
thead th{
  border-bottom: 2px solid var(--grid);
}

.badge-today{
  background:color-mix(in srgb, var(--accent) 90%, #fff);
  color:#fff;
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  font-weight:700;
  letter-spacing:0.02em;
}

.hourmark{ font-weight:700; color:#244640; }




/* Su mobile il bordo resta visibile ma i colori restano leggeri */
@media (max-width: 600px){
  table tr{
    border-top: 1px solid color-mix(in oklab, var(--grid) 60%, #0000);
    border-bottom: 1px solid color-mix(in oklab, var(--grid) 60%, #0000);
  }
  table td, table th{
    border-left: 1px solid color-mix(in oklab, var(--grid) 60%, #0000);
    border-right: 1px solid color-mix(in oklab, var(--grid) 60%, #0000);
  }
}


  </style>
</head>
<body>
  <div class="wrap">
    <h1>Orario settimanale</h1>
    <p class="hint">Consulta l’orario della classe e le eventuali variazioni settimanali. Seleziona la classe desiderata.</p>

    <div class="card">
      <div class="row">
        <label>Classe: <select id="selClasse" disabled></select></label>
        <label>Giorno: <input id="inpDate" type="date" disabled/></label>
        <button id="btnRender" disabled>MOSTRA ORARIO</button>
        <span class="hint" id="weekInfo"></span>
        <div id="status" class="status-row" role="status" aria-live="polite"></div>
      </div>
      <div class="tt" id="timetableTarget"></div>
    </div>

    <details>
      <summary>Debug Tools</summary>
      <div style="margin-top: 16px;">
        <p class="hint">You can manually load an XML file to test the display without calling the server.</p>
        <div class="row">
          <input id="xmlFileManual" type="file" accept=".xml,text/xml" />
          <button id="btnParseManual">Import from File</button>
          <button id="btnLog">Log EDT Object</button>
        </div>
      </div>
    </details>
  </div>

  <!-- Include the data processing logic -->
  <?!= HtmlService.createHtmlOutputFromFile('edt.js').getContent(); ?>

  <script>
    const $ = s => document.querySelector(s);
    
    /* ===================== STATE MANAGEMENT & APP STARTUP ===================== */
    window.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp(){
      setStatus('loading', 'Caricamento dati...si prega di attendere');
      google.script.run
        .withSuccessHandler(onXmlReceived)
        .withFailureHandler(onXmlError)
        .getEdtXml();
    }
    
    function onXmlReceived(xmlText){
      try {
        if (!xmlText || xmlText.startsWith('Error')) {
            throw new Error(xmlText || 'The received XML is empty.');
        }
        const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
        if (doc.querySelector('parsererror')) {
            throw new Error('Invalid or malformed XML.');
        }
        processEDT(doc);
        setStatus('ok', 'I dati sono stati caricati. Seleziona la classe e il giorno di tuo interesse.');
      } catch (e) {
        console.error('Error parsing or processing XML:', e);
        setStatus('err', 'Error: ' + e.message);
      }
    }

    function onXmlError(error){
      console.error('Server call error (getEdtXml):', error);
      setStatus('err', 'Server error: ' + error.message);
    }
    
    function processEDT(doc) {
      // buildEDT is from edt.js.html
      const EDT = buildEDT(doc);
      EDT.classe = EDT.Classe; // alias
      EDT.salle  = EDT.Salle; // alias
      window.EDT = EDT;
      
      populateClassSelect(EDT);
      $('#inpDate').disabled = false;
      $('#btnRender').disabled = false;
      setDefaultDate();
      renderFromUI(); // Immediately show the timetable
    }

    function setStatus(kind, msg){
      const el = $('#status');
      el.innerHTML = (kind === 'loading' ? '<div class="loader" aria-hidden="true"></div>' : '') + (msg || '');
      el.className = 'status-row ' + (kind || 'hint');
    }

    /* ===================== UI & EVENTS ===================== */
    $('#btnParseManual').addEventListener('click', async () => {
      const file = $('#xmlFileManual').files?.[0];
      if (!file) return setStatus('warn', 'Select an XML file from the debug section.');
      try {
        setStatus('loading', 'Reading manual file...');
        const xmlText = await file.text();
        const doc = new DOMParser().parseFromString(xmlText, 'application/xml');
        if (doc.querySelector('parsererror')) throw new Error('Invalid XML in file');
        processEDT(doc);
        setStatus('ok', 'EDT from manual file is ready.');
      } catch (e) {
        console.error(e);
        setStatus('err', 'Manual file error: ' + e.message);
      }
    });

    $('#btnLog').addEventListener('click', () => window.EDT ? console.log('EDT', window.EDT) : setStatus('warn', 'No EDT object has been created yet.'));
    $('#btnRender').addEventListener('click', renderFromUI);
    $('#selClasse').addEventListener('change', renderFromUI);
    $('#inpDate').addEventListener('change', renderFromUI);

    function populateClassSelect(EDT){
      const sel = $('#selClasse'); sel.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Seleziona un docente';
      placeholder.selected = true;
      placeholder.disabled = true;
      sel.appendChild(placeholder);
      const classes = Object.entries(EDT.Classe || {}).sort((a,b)=> (a[1].Nom||'').localeCompare(b[1].Nom||''));
      for (const [id, c] of classes){
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = c.Nom || id;
        sel.appendChild(opt);
      }
      sel.disabled = classes.length === 0;
    }

    function setDefaultDate(){
      $('#inpDate').value = new Date().toISOString().slice(0,10);
    }

    function todayLocalISO() {
    // Europa/Roma per evitare slittamenti con UTC
    const d = new Date();
    const z = new Date(d.toLocaleString('en-CA', { timeZone: 'Europe/Rome' }));
    const y = z.getFullYear();
    const m = String(z.getMonth()+1).padStart(2,'0');
    const day = String(z.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
}

function renderFromUI(){
  const EDT = window.EDT; if (!EDT) return;
  const classId = $('#selClasse').value;
  if (!classId) {
    $('#timetableTarget').innerHTML = '<p class="hint">Seleziona la classe per vedere le eventuali variazioni settimanali</p>';
    return;
  }

  const dateIso = $('#inpDate').value || todayLocalISO();

  // Calcolo settimana (funzioni definite in edt.js.html)
  const { start, end, week } = getWeekDateRange(dateIso);

  // dd-mm-yyyy per la scritta sopra
  function formatDate(isoString) {
    const [year, month, day] = isoString.split('-');
    return `${day}-${month}-${year}`;
  }
  $('#weekInfo').textContent = `Settimana n.${week} - dal ${formatDate(start)} al ${formatDate(end)}`;

  // Dati dei corsi
  const rawCourses = coursesForClassAndWeek(EDT, classId, week);
  const mergedCourses = compressCoursesByHour(rawCourses);

  // ⬇️ QUI è il punto chiave: passiamo le date a renderTimetableByHour
  // weekStartIso = 'start' della settimana corrente
  // todayIso     = data locale di oggi (Europa/Roma)
  renderTimetableByHour(EDT, mergedCourses, 'timetableTarget', {
    weekStartIso: start,
    todayIso: todayLocalISO()
  });
}

  </script>
</body>
</html>
